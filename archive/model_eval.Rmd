---
title: "Model Evaluations"
author: "Shira Salingr√©"
date: "20/05/2021"
output: html_document
---

```{r setup, include=FALSE}
source("R/models.R", echo = FALSE)
guilds <- c("groupers", "seabreams", "herbivores")

```

### Relevant documentation

[**MRFcov documentation**](https://cran.r-project.org/web/packages/MRFcov/MRFcov.pdf) See pages 5-8 (cv_MRF_diag functions)

## Poisson model relative importance results

```{r fig.height=11, echo=FALSE}
patch_plot
```

## Poisson model diagnostics

I can evaluate the Poisson (CRF) model by its deviance or MSE. The MSE value isn't insightful on its own (to my understanding), so I compared it to the same model, running without the covariates (MRF).

```{r message=FALSE, warning=FALSE, results='hide', fig.show='show', cache=TRUE, fig.height=4, fig.width=4}
cv.preds.list <- lapply(species_mats, FUN = function(x){
  my_cv_MRF_diag_rep(data = x, n_nodes = 4, family = 'poisson',
                  compare_null = TRUE, plot = FALSE, n_fold_runs = 100)})
names(cv.preds.list) <- guilds  

# Plot each
lapply(1:3, function(i){
  guild <- cv.preds.list[[i]]
  deviance <- guild %>% 
    ggplot() + aes(y = Deviance, x = model) + 
    geom_boxplot() + 
    theme(axis.text.x = element_blank()) +
    labs(x = '') +
    ggtitle(names(cv.preds.list)[i])
  mse <- guild %>% 
    ggplot() + aes(y = MSE, x = model) + 
    geom_boxplot()
  
  return(gridExtra::grid.arrange(deviance, mse, ncol = 1))
})

```
Calculate mean deviance
```{r}
tibble(Group = c("Groupers", "Seabreams", "Herbivores"),
       Mean_Deviance = c(cv.preds.list$groupers %>% filter(model == "CRF") %>% summarise(mean(Deviance)) %>% as.double(), 
                   cv.preds.list$seabreams %>% filter(model == "CRF") %>% summarise(mean(Deviance)) %>% as.double(), 
                   cv.preds.list$herbivores %>% filter(model == "CRF") %>% summarise(mean(Deviance)) %>% as.double()
       ))
```

... and Mean MSE
```{r}
tibble(Group = c("Groupers", "Seabreams", "Herbivores"),
       Mean_MSE = c(cv.preds.list$groupers %>% filter(model == "CRF") %>% summarise(mean(MSE)) %>% as.double(), 
                   cv.preds.list$seabreams %>% filter(model == "CRF") %>% summarise(mean(MSE)) %>% as.double(), 
                   cv.preds.list$herbivores %>% filter(model == "CRF") %>% summarise(mean(MSE)) %>% as.double()
       ))
```



## Biomass model relative importance results

```{r fig.height=11, echo=FALSE}
patch_plot_mass
```

## Biomass model diagnostics

I can evaluate the biomass (CRF) model by its deviance or MSE. The MSE value isn't insightful on its own (to my understanding), so I compared it to the same model, running without the covariates (MRF).

```{r message=FALSE, warning=FALSE, results='hide', fig.show='show', cache=TRUE, fig.height=4, fig.width=4}
cv.biomass.list <- lapply(species_mats_mass, FUN = function(x){
  cv_MRF_diag_rep(data = x, n_nodes = 4, family = 'gaussian',
                  compare_null = TRUE, plot = FALSE, n_fold_runs = 100)})
names(cv.biomass.list) <- guilds  

# Plot each
lapply(1:3, function(i){
  guild <- cv.biomass.list[[i]]
  deviance <- guild %>% 
    ggplot() + aes(y = Rsquared, x = model) + 
    geom_boxplot() + 
    theme(axis.text.x = element_blank()) +
    labs(x = '') +
    ggtitle(names(cv.biomass.list)[i])
  mse <- guild %>% 
    ggplot() + aes(y = MSE, x = model) + 
    geom_boxplot()
  
  return(gridExtra::grid.arrange(deviance, mse, ncol = 1))
})

```
Check the Mean R^2 for each model

```{r}
tibble(Group = c("Groupers", "Seabreams", "Herbivores"),
       Mean_R2 = c(cv.biomass.list$groupers %>% filter(model == "CRF") %>% 
                     summarise(round(mean(Rsquared), 3)) %>% as.double(),
                   cv.biomass.list$seabreams %>% filter(model == "CRF") %>% 
                     summarise(round(mean(Rsquared), 3)) %>% as.double(),
                   cv.biomass.list$herbivores %>% filter(model == "CRF") %>% 
                     summarise(round(mean(Rsquared), 3)) %>% as.double()
))
```

... and Mean MSE
```{r}
tibble(Group = c("Groupers", "Seabreams", "Herbivores"),
       Mean_MSE = c(cv.biomass.list$groupers %>% filter(model == "CRF") %>% summarise(mean(MSE)) %>% as.double(), 
                   cv.biomass.list$seabreams %>% filter(model == "CRF") %>% summarise(mean(MSE)) %>% as.double(), 
                   cv.biomass.list$herbivores %>% filter(model == "CRF") %>% summarise(mean(MSE)) %>% as.double()
       ))
```

